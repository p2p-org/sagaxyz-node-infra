apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: saga-chainlet-rules
  namespace: sagasrv-metrics
spec:
  groups:
  - name: chainlet-group
    rules:
    - alert: ChainletJailedValidator
      annotations:
        description: Jailed validator *{% raw %}{{ $labels.moniker }}{% endraw %}* on *{% raw %}{{ $labels.chainId }}{% endraw %}*
        summary: Jailed validator
      expr: sum(cosmos_validators_jailed{app="cosmos-exporter", moniker="{{ moniker }}"}) by (moniker, chainId) > 0
      labels:
        severity: critical
    - alert: ChainletByzantineValidator
      annotations:
        description: Byzantine validator(s) on *{% raw %}{{ $labels.chainId }}{% endraw %}* ({% raw %}{{ $value }}{% endraw %})
        summary: Byzantine validator
      expr: sum(cometbft_consensus_byzantine_validators{app="chainlet"}) by (chainId) > 0
      labels:
        severity: critical
    - alert: ChainletMissedBlocks
      annotations:
        description: "*{% raw %}{{ $labels.moniker }}{% endraw %}* missed *{% raw %}{{ $value }}{% endraw %}* blocks on *{% raw %}{{ $labels.chainId }}{% endraw %}* in 5 minutes"
        summary: Missed more than 10 blocks in 5m
      expr: delta(cosmos_validators_missed_blocks{app="cosmos-exporter", moniker="{{ moniker }}"}[5m]) > 10
      labels:
        severity: critical
    - alert: ChainletNotProducingBlocks
      annotations:
        description: "*{% raw %}{{ $labels.chainId }}{% endraw %}* didn't produced blocks in the last minute"
        summary: No blocks produced in the last minute
      expr: delta(cometbft_consensus_height{app="chainlet"}[1m]) < 1
      labels:
        severity: critical
    - alert: ChainletAverageBlockTimeTooLong
      annotations:
        description: Average block time for *{% raw %}{{ $labels.chainId }}{% endraw %}* is *{% raw %}{{ $value }}{% endraw %}* seconds
        summary: Average block time too long
      expr: sum(blockscout_average_block_time) by (chainId) / 1000 > 20
      labels:
        severity: warning
    - alert: ChainletMempoolTooBig
      annotations:
        description: Mempool for *{% raw %}{{ $labels.chainId }}{% endraw %}* is *{% raw %}{{ $value }}{% endraw %}*
        summary: Mempool bigger than 300
      expr: sum(cometbft_mempool_size{app="chainlet"}) by (chainId) > 300
      labels:
        severity: warning
